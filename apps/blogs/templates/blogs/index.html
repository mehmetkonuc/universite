{% extends 'partials/base.html' %}
{% load static %}
{% load crispy_forms_tags %}
{% block extra_css %}
<link rel="stylesheet" href="{% static 'assets/vendor/libs/bootstrap-select/bootstrap-select.css' %}" />
<style>
   .card img {
   height: 200px; /* İstediğiniz yükseklik */
   object-fit: cover; /* Resmi alanın tamamına sığdır */
   width: 100%; /* Resmi genişliğe yay */
   }
</style>
{% endblock extra_css%}
{% block content %}
<div class="row">
   <div class="d-flex flex-column flex-md-row justify-content-end align-items-end align-items-md-end mb-6 row-gap-4">
      <div class="d-flex gap-4">
         <a href="{% url 'article_add' %}" class="btn btn-sm btn-label-primary rounded-pill" ><i class="ti ti-plus me-1"></i>Oluştur</a>
         <button class="btn btn-sm btn-label-danger rounded-pill" data-bs-toggle="offcanvas" data-bs-target="#filter-canvas" aria-controls="offcanvasEnd"><i class="ti ti-filter-check me-1"></i>Filtre</button>
      </div>
   </div>
</div>
<!-- Makaleler Grid Yapısı -->
   <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4" id="article-container">
      {% include 'blogs/article_list.html' %}
   </div>
   <!-- Yükleniyor Görüntüsü -->
<div id="loading" style="display: none; text-align: center;">
   <img src="{% static 'assets/img/loading.gif' %}" alt="Loading...">
</div>
<!-- Canvas -->
<div
   class="offcanvas offcanvas-end"
   tabindex="-1"
   id="filter-canvas"
   aria-labelledby="offcanvasEndLabel">
   <div class="offcanvas-header">
      <h5 id="offcanvasEndLabel" class="offcanvas-title">Filtrele</h5>
      <button
         type="button"
         class="btn-close text-reset"
         data-bs-dismiss="offcanvas"
         aria-label="Close"></button>
   </div>
   <div class="offcanvas-body mx-0 flex-grow-0">
      <form method="post">
         {% csrf_token %}
         {{filter_form|crispy}}
         <button type="submit" class="btn btn-primary mb-2 d-grid w-100">Filtrele</button>
         <button type="submit" class="btn btn-danger mb-2 d-grid w-100" name="reset_filter">Filtreyi Temizle</button>
         <button
            type="button"
            class="btn btn-label-secondary d-grid w-100"
            data-bs-dismiss="offcanvas">
         Vazgeç
         </button>
      </form>
   </div>
</div>
<!-- End Canvas -->
{% endblock content %}
{% block extra_javascript %}
<script src="{% static 'assets/vendor/libs/bootstrap-select/bootstrap-select.js' %}"></script>
<script>
   let page = 2;  // İlk sayfa zaten yüklü olduğu için 2. sayfadan başlayacağız
   const container = document.getElementById('article-container');
   const loading = document.getElementById('loading');
   let loadingInProgress = false;  // Aynı anda birden fazla istek yapılmasını önlemek için
   let hasNextPage = true;  // Daha fazla sayfa olup olmadığını takip et
   
   window.onscroll = function() {
       if (!loadingInProgress && hasNextPage && (window.innerHeight + window.scrollY >= document.body.offsetHeight - 200)) {
           loadingInProgress = true;
           loading.style.display = 'block';
   
           const xhr = new XMLHttpRequest();
           xhr.open('GET', `?page=${page}`, true);
           xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
           xhr.onload = function() {
               if (xhr.status === 200) {
                   const response = JSON.parse(xhr.responseText);
                   const div = document.createElement('div');
                   div.innerHTML = response.article_list_html;
                   while (div.firstChild) {
                       container.appendChild(div.firstChild);
                   }
                   hasNextPage = response.has_next;  // Sonraki sayfanın olup olmadığını güncelle
                   if (!hasNextPage) {
                       loading.style.display = 'none';  // Daha fazla sayfa yoksa yükleme görüntüsünü sakla
                   }
                   loadingInProgress = false;  // İstek tamamlandığında yeni istek yapılabilir
                   page++;  // Sayfa numarasını artır
               }
           };
           xhr.send();
       }
   };
</script>


{% endblock extra_javascript %}